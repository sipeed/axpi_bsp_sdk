(function(e){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=e()}else if(typeof define==="function"&&define.amd){define([],e)}else{var t;if(typeof window!=="undefined"){t=window}else if(typeof global!=="undefined"){t=global}else if(typeof self!=="undefined"){t=self}else{t=this}t.Wfs=e()}})(function(){var r,e,t;return function(){function f(a,o,s){function u(n,e){if(!o[n]){if(!a[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(l)return l(n,!0);var r=new Error("Cannot find module '"+n+"'");throw r.code="MODULE_NOT_FOUND",r}var i=o[n]={exports:{}};a[n][0].call(i.exports,function(e){var t=a[n][1][e];return u(t||e)},i,i.exports,f,a,o,s)}return o[n].exports}for(var l="function"==typeof require&&require,e=0;e<s.length;e++)u(s[e]);return u}return f}()({1:[function(e,t,n){"use strict";var r=typeof Reflect==="object"?Reflect:null;var c=r&&typeof r.apply==="function"?r.apply:function e(t,n,r){return Function.prototype.apply.call(t,n,r)};var i;if(r&&typeof r.ownKeys==="function"){i=r.ownKeys}else if(Object.getOwnPropertySymbols){i=function e(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}}else{i=function e(t){return Object.getOwnPropertyNames(t)}}function u(e){if(console&&console.warn)console.warn(e)}var a=Number.isNaN||function e(t){return t!==t};function o(){o.init.call(this)}t.exports=o;t.exports.once=E;o.EventEmitter=o;o.prototype._events=undefined;o.prototype._eventsCount=0;o.prototype._maxListeners=undefined;var s=10;function l(e){if(typeof e!=="function"){throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}}Object.defineProperty(o,"defaultMaxListeners",{enumerable:true,get:function(){return s},set:function(e){if(typeof e!=="number"||e<0||a(e)){throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".")}s=e}});o.init=function(){if(this._events===undefined||this._events===Object.getPrototypeOf(this)._events){this._events=Object.create(null);this._eventsCount=0}this._maxListeners=this._maxListeners||undefined};o.prototype.setMaxListeners=function e(t){if(typeof t!=="number"||t<0||a(t)){throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".")}this._maxListeners=t;return this};function f(e){if(e._maxListeners===undefined)return o.defaultMaxListeners;return e._maxListeners}o.prototype.getMaxListeners=function e(){return f(this)};o.prototype.emit=function e(t){var n=[];for(var r=1;r<arguments.length;r++)n.push(arguments[r]);var i=t==="error";var a=this._events;if(a!==undefined)i=i&&a.error===undefined;else if(!i)return false;if(i){var o;if(n.length>0)o=n[0];if(o instanceof Error){throw o}var s=new Error("Unhandled error."+(o?" ("+o.message+")":""));s.context=o;throw s}var u=a[t];if(u===undefined)return false;if(typeof u==="function"){c(u,this,n)}else{var l=u.length;var f=v(u,l);for(var r=0;r<l;++r)c(f[r],this,n)}return true};function d(e,t,n,r){var i;var a;var o;l(n);a=e._events;if(a===undefined){a=e._events=Object.create(null);e._eventsCount=0}else{if(a.newListener!==undefined){e.emit("newListener",t,n.listener?n.listener:n);a=e._events}o=a[t]}if(o===undefined){o=a[t]=n;++e._eventsCount}else{if(typeof o==="function"){o=a[t]=r?[n,o]:[o,n]}else if(r){o.unshift(n)}else{o.push(n)}i=f(e);if(i>0&&o.length>i&&!o.warned){o.warned=true;var s=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners "+"added. Use emitter.setMaxListeners() to "+"increase limit");s.name="MaxListenersExceededWarning";s.emitter=e;s.type=t;s.count=o.length;u(s)}}return e}o.prototype.addListener=function e(t,n){return d(this,t,n,false)};o.prototype.on=o.prototype.addListener;o.prototype.prependListener=function e(t,n){return d(this,t,n,true)};function p(){if(!this.fired){this.target.removeListener(this.type,this.wrapFn);this.fired=true;if(arguments.length===0)return this.listener.call(this.target);return this.listener.apply(this.target,arguments)}}function h(e,t,n){var r={fired:false,wrapFn:undefined,target:e,type:t,listener:n};var i=p.bind(r);i.listener=n;r.wrapFn=i;return i}o.prototype.once=function e(t,n){l(n);this.on(t,h(this,t,n));return this};o.prototype.prependOnceListener=function e(t,n){l(n);this.prependListener(t,h(this,t,n));return this};o.prototype.removeListener=function e(t,n){var r,i,a,o,s;l(n);i=this._events;if(i===undefined)return this;r=i[t];if(r===undefined)return this;if(r===n||r.listener===n){if(--this._eventsCount===0)this._events=Object.create(null);else{delete i[t];if(i.removeListener)this.emit("removeListener",t,r.listener||n)}}else if(typeof r!=="function"){a=-1;for(o=r.length-1;o>=0;o--){if(r[o]===n||r[o].listener===n){s=r[o].listener;a=o;break}}if(a<0)return this;if(a===0)r.shift();else{g(r,a)}if(r.length===1)i[t]=r[0];if(i.removeListener!==undefined)this.emit("removeListener",t,s||n)}return this};o.prototype.off=o.prototype.removeListener;o.prototype.removeAllListeners=function e(t){var n,r,i;r=this._events;if(r===undefined)return this;if(r.removeListener===undefined){if(arguments.length===0){this._events=Object.create(null);this._eventsCount=0}else if(r[t]!==undefined){if(--this._eventsCount===0)this._events=Object.create(null);else delete r[t]}return this}if(arguments.length===0){var a=Object.keys(r);var o;for(i=0;i<a.length;++i){o=a[i];if(o==="removeListener")continue;this.removeAllListeners(o)}this.removeAllListeners("removeListener");this._events=Object.create(null);this._eventsCount=0;return this}n=r[t];if(typeof n==="function"){this.removeListener(t,n)}else if(n!==undefined){for(i=n.length-1;i>=0;i--){this.removeListener(t,n[i])}}return this};function y(e,t,n){var r=e._events;if(r===undefined)return[];var i=r[t];if(i===undefined)return[];if(typeof i==="function")return n?[i.listener||i]:[i];return n?b(i):v(i,i.length)}o.prototype.listeners=function e(t){return y(this,t,true)};o.prototype.rawListeners=function e(t){return y(this,t,false)};o.listenerCount=function(e,t){if(typeof e.listenerCount==="function"){return e.listenerCount(t)}else{return m.call(e,t)}};o.prototype.listenerCount=m;function m(e){var t=this._events;if(t!==undefined){var n=t[e];if(typeof n==="function"){return 1}else if(n!==undefined){return n.length}}return 0}o.prototype.eventNames=function e(){return this._eventsCount>0?i(this._events):[]};function v(e,t){var n=new Array(t);for(var r=0;r<t;++r)n[r]=e[r];return n}function g(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function b(e){var t=new Array(e.length);for(var n=0;n<t.length;++n){t[n]=e[n].listener||e[n]}return t}function E(i,a){return new Promise(function(e,t){function n(e){i.removeListener(a,r);t(e)}function r(){if(typeof i.removeListener==="function"){i.removeListener("error",n)}e([].slice.call(arguments))}S(i,a,r,{once:true});if(a!=="error"){_(i,n,{once:true})}})}function _(e,t,n){if(typeof e.on==="function"){S(e,"error",t,n)}}function S(n,r,i,a){if(typeof n.on==="function"){if(a.once){n.once(r,i)}else{n.on(r,i)}}else if(typeof n.addEventListener==="function"){n.addEventListener(r,function e(t){if(a.once){n.removeEventListener(r,e)}i(t)})}else{throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}}},{}],2:[function(e,t,n){"use strict";function r(e){"@babel/helpers - typeof";return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var s=e("../errors");var u=o(e("../events"));var i=o(e("../event-handler"));var a=o(e("./fix-webm-duration"));function o(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function c(e,t,n){if(t)f(e.prototype,t);if(n)f(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}function d(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)p(e,t)}function p(e,t){p=Object.setPrototypeOf||function e(t,n){t.__proto__=n;return t};return p(e,t)}function h(i){var a=v();return function e(){var t=g(i),n;if(a){var r=g(this).constructor;n=Reflect.construct(t,arguments,r)}else{n=t.apply(this,arguments)}return y(this,n)}}function y(e,t){if(t&&(r(t)==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return m(e)}function m(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function v(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function g(e){g=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return g(e)}var b=function(e){d(r,e);var n=h(r);function r(e){var t;l(this,r);t=n.call(this,e,u.default.MEDIA_ATTACHING,u.default.BUFFER_APPENDING,u.default.BUFFER_RESET,u.default.RECORDING_START,u.default.RECORDING_STOP);t.rec_threshold_total=16*(1024*1024*1024);t.rec_threshold_single=1*(1024*1024*1024);t.rec_mimeType="video/webm";t.rec_blobType="video/webm";t.rec_file_ext=".webm";t.rec_timer=undefined;t.rec_start_tm=0;t.rec_file="";t.rec_result_cb=undefined;t.rec_state_cb=undefined;t.mediaSource=null;t.mediaRecorder=null;t.mediaParts=[];t.mediaSize=0;t.media=null;t.pendingTracks={};t.sourceBuffer={};t.segments=[];t.appended=0;t._msDuration=null;t.mediaErrorCount=0;t.count=0;t.onsbue=t.onSBUpdateEnd.bind(m(t));t.browserType=0;if(navigator.userAgent.toLowerCase().indexOf("firefox")!==-1){t.browserType=1}t.mediaType="";t.websocketName=undefined;t.channelName=undefined;t._fs=null;return t}c(r,[{key:"destroy",value:function e(){i.default.prototype.destroy.call(this)}},{key:"pad2",value:function e(t){return t<10?"0"+t:t}},{key:"onRecordingProc",value:function e(){var r=this;if(r._fs==null){if(r.rec_result_cb){r.rec_result_cb(false)}console.log("fs is not authorized");return}if(r.rec_timer){clearInterval(r.rec_timer);r.rec_timer=undefined}r.count=0;r.rec_timer=setInterval(function(){if(r.mediaType==""||r.mediaType=="H264Raw"&&r.appended>10){clearInterval(r.rec_timer);r.rec_timer=undefined;var e=new Date;var t=1900+e.getYear()+"-"+r.pad2(e.getMonth()+1)+"-"+r.pad2(e.getDate())+"_"+r.pad2(e.getHours())+"-"+r.pad2(e.getMinutes())+"-"+r.pad2(e.getSeconds());r.rec_file="ax_"+t+r.rec_file_ext;r.mediaParts=[];r.mediaSize=0;r.mediaRecorder=new MediaRecorder(r.wfs.media.captureStream(),{mimeType:r.rec_mimeType});r.mediaRecorder.start(500);r.rec_start_tm=Date.now();r.mediaRecorder.ondataavailable=function(e){var t=e.data;if(t&&t.size>0){r.mediaParts.push(t);r.mediaSize+=t.size;if(r.mediaSize>=r.rec_threshold_single){if(r.rec_state_cb){r.rec_state_cb(false)}r.onRecordingStop();r.onRecordingStart();if(r.rec_state_cb){r.rec_state_cb(true)}}}};r.mediaRecorder.onstop=function(){var n=r.rec_file;var e=Date.now()-r.rec_start_tm;var t=new Blob(r.mediaParts,{type:r.rec_blobType});(0,a.default)(t,e,function(e){var t=Date.now();console.log("Start to save blob to webm file...");r.writeData(n,e);console.log("Save webm file finished, elapsed: "+(Date.now()-t))})};console.log("MediaRecorder started: "+r.rec_file);if(r.rec_result_cb){r.rec_result_cb(true)}}else{r.count++}if(r.count>=10){clearInterval(r.rec_timer);r.rec_timer=undefined;if(r.rec_result_cb){r.rec_result_cb(false)}}},1e3)}},{key:"onRecordingStart",value:function e(t){if(this.mediaRecorder&&this.mediaRecorder.state!="inactive"){console.log("recording is in progress");return}if(t!=undefined){this.rec_threshold_single=t.rec_file_threshold;this.rec_result_cb=t.result_cb;this.rec_state_cb=t.state_cb}var n=this;navigator.webkitPersistentStorage.queryUsageAndQuota(function(e,t){if(t==""){console.log("File system(sandbox) not requested.");n.requestFs()}else{console.log("Used space: "+e+" bytes");console.log("Total space: "+t+" bytes");window.webkitRequestFileSystem(window.PERSISTENT,n.rec_threshold_total,function(e){n._fs=e;e.root.getDirectory("ax_video",{create:true},function(e){console.log("Directory: "+e.name+" fs requested");n.onRecordingProc()},n.errorHandler)})}},this.errorHandler)}},{key:"onRecordingStop",value:function e(){if(this.mediaRecorder&&this.mediaRecorder.state!="inactive"){if(this.rec_timer){clearInterval(this.rec_timer);this.rec_timer=undefined}this.mediaRecorder.stop();console.log("MediaRecorder stopped")}}},{key:"errorHandler",value:function e(t){var n="An error occured(errcd): ";console.log(n+t.code)}},{key:"requestFs",value:function e(){var t=this;navigator.webkitPersistentStorage.requestQuota(this.rec_threshold_total,function(e){console.log("grantedBytes: "+e);if(e>0){window.webkitRequestFileSystem(window.PERSISTENT,e,function(e){t._fs=e;e.root.getDirectory("ax_video",{create:true},function(e){console.log("Directory: "+e.name+" exists or just created.");t.onRecordingProc()},t.errorHandler)})}else{if(t.rec_result_cb){t.rec_result_cb(false)}}})}},{key:"onMediaAttaching",value:function e(t){var n=this.media=t.media;this.mediaType=t.mediaType;this.websocketName=t.websocketName;this.channelName=t.channelName;if(n){var r=this.mediaSource=new MediaSource;this.onmso=this.onMediaSourceOpen.bind(this);this.onmse=this.onMediaSourceEnded.bind(this);this.onmsc=this.onMediaSourceClose.bind(this);r.addEventListener("sourceopen",this.onmso);r.addEventListener("sourceended",this.onmse);r.addEventListener("sourceclose",this.onmsc);n.src=URL.createObjectURL(r)}}},{key:"onMediaDetaching",value:function e(){}},{key:"writeData",value:function e(t,n){var r=this;this._fs.root.getFile("ax_video/"+t,{create:true},function(e){e.createWriter(function(e){e.onwriteend=function(e){};e.onerror=function(e){console.log("Write rec data failed: "+e.toString())};e.seek(e.length);e.write(n)},r.errorHandler)},this.errorHandler)}},{key:"onBufferAppending",value:function e(t){if(!this.segments){this.segments=[t]}else{this.segments.push(t)}this.doAppending()}},{key:"onMediaSourceClose",value:function e(){console.log("media source closed")}},{key:"onMediaSourceEnded",value:function e(){console.log("media source ended")}},{key:"onSBUpdateEnd",value:function e(t){if(this.browserType===1){this.mediaSource.endOfStream();this.media.play()}this.appending=false;this.doAppending();this.updateMediaElementDuration()}},{key:"updateMediaElementDuration",value:function e(){}},{key:"onMediaSourceOpen",value:function e(){console.log("media source open");var t=this.mediaSource;if(t){t.removeEventListener("sourceopen",this.onmso)}if(this.mediaType==="FMp4"){this.checkPendingTracks()}this.wfs.trigger(u.default.MEDIA_ATTACHED,{media:this.media,channelName:this.channelName,mediaType:this.mediaType,websocketName:this.websocketName})}},{key:"checkPendingTracks",value:function e(){this.createSourceBuffers({tracks:"video",mimeType:""});this.pendingTracks={}}},{key:"onBufferReset",value:function e(t){if(this.mediaType==="H264Raw"){this.createSourceBuffers({tracks:"video",mimeType:t.mimeType})}}},{key:"createSourceBuffers",value:function e(t){var n=this.sourceBuffer,r=this.mediaSource;var i;if(t.mimeType===""){i="video/mp4;codecs=avc1.420028"}else{i="video/mp4;codecs="+t.mimeType}try{var a=n["video"]=r.addSourceBuffer(i);a.addEventListener("updateend",this.onsbue);t.buffer=a}catch(e){}this.wfs.trigger(u.default.BUFFER_CREATED,{tracks:t});this.media.play()}},{key:"doAppending",value:function e(){var t=this.wfs,n=this.sourceBuffer,r=this.segments;if(Object.keys(n).length){if(this.media.error){this.segments=[];this.mediaErrorCount++;if(this.mediaErrorCount<100){console.log("trying to append although a media error occured, flush segment and abort")}else{var i={type:s.ErrorTypes.MEDIA_ERROR};i.details=s.ErrorDetails.BUFFER_APPEND_ERROR;i.frag=this.fragCurrent;i.fatal=true;this.wfs.trigger(u.default.ERROR,i)}return}this.mediaErrorCount=0;if(this.appending){return}if(r&&r.length){var a=r.shift();try{if(n[a.type]){this.parent=a.parent;n[a.type].appendBuffer(a.data);this.appendError=0;this.appended++;this.appending=true}else{}}catch(e){r.unshift(a);var o={type:s.ErrorTypes.MEDIA_ERROR};if(e.code!==22){if(this.appendError){this.appendError++}else{this.appendError=1}o.details=s.ErrorDetails.BUFFER_APPEND_ERROR;o.frag=this.fragCurrent;if(this.appendError>t.config.appendErrorMaxRetry){r=[];o.fatal=true}else{o.fatal=false}}else{this.segments=[];o.details=s.ErrorDetails.BUFFER_FULL_ERROR;o.fatal=true}this.wfs.trigger(u.default.ERROR,o)}}}}}]);return r}(i.default);var E=b;n.default=E},{"../errors":7,"../event-handler":8,"../events":9,"./fix-webm-duration":3}],3:[function(e,n,t){"use strict";(function(e,t){if(typeof r==="function"&&r.amd){r(t)}else if(typeof n!=="undefined"&&n.exports){n.exports=t()}else{window.ysFixWebmDuration=t()}})("fix-webm-duration",function(){var s={172351395:{name:"EBML",type:"Container"},646:{name:"EBMLVersion",type:"Uint"},759:{name:"EBMLReadVersion",type:"Uint"},754:{name:"EBMLMaxIDLength",type:"Uint"},755:{name:"EBMLMaxSizeLength",type:"Uint"},642:{name:"DocType",type:"String"},647:{name:"DocTypeVersion",type:"Uint"},645:{name:"DocTypeReadVersion",type:"Uint"},108:{name:"Void",type:"Binary"},63:{name:"CRC-32",type:"Binary"},190023271:{name:"SignatureSlot",type:"Container"},16010:{name:"SignatureAlgo",type:"Uint"},16026:{name:"SignatureHash",type:"Uint"},16037:{name:"SignaturePublicKey",type:"Binary"},16053:{name:"Signature",type:"Binary"},15963:{name:"SignatureElements",type:"Container"},15995:{name:"SignatureElementList",type:"Container"},9522:{name:"SignedElement",type:"Binary"},139690087:{name:"Segment",type:"Container"},21863284:{name:"SeekHead",type:"Container"},3515:{name:"Seek",type:"Container"},5035:{name:"SeekID",type:"Binary"},5036:{name:"SeekPosition",type:"Uint"},88713574:{name:"Info",type:"Container"},13220:{name:"SegmentUID",type:"Binary"},13188:{name:"SegmentFilename",type:"String"},1882403:{name:"PrevUID",type:"Binary"},1868715:{name:"PrevFilename",type:"String"},2013475:{name:"NextUID",type:"Binary"},1999803:{name:"NextFilename",type:"String"},1092:{name:"SegmentFamily",type:"Binary"},10532:{name:"ChapterTranslate",type:"Container"},10748:{name:"ChapterTranslateEditionUID",type:"Uint"},10687:{name:"ChapterTranslateCodec",type:"Uint"},10661:{name:"ChapterTranslateID",type:"Binary"},710577:{name:"TimecodeScale",type:"Uint"},1161:{name:"Duration",type:"Float"},1121:{name:"DateUTC",type:"Date"},15273:{name:"Title",type:"String"},3456:{name:"MuxingApp",type:"String"},5953:{name:"WritingApp",type:"String"},103:{name:"Timecode",type:"Uint"},6228:{name:"SilentTracks",type:"Container"},6359:{name:"SilentTrackNumber",type:"Uint"},39:{name:"Position",type:"Uint"},43:{name:"PrevSize",type:"Uint"},35:{name:"SimpleBlock",type:"Binary"},32:{name:"BlockGroup",type:"Container"},33:{name:"Block",type:"Binary"},34:{name:"BlockVirtual",type:"Binary"},13729:{name:"BlockAdditions",type:"Container"},38:{name:"BlockMore",type:"Container"},110:{name:"BlockAddID",type:"Uint"},37:{name:"BlockAdditional",type:"Binary"},27:{name:"BlockDuration",type:"Uint"},122:{name:"ReferencePriority",type:"Uint"},123:{name:"ReferenceBlock",type:"Int"},125:{name:"ReferenceVirtual",type:"Int"},36:{name:"CodecState",type:"Binary"},13730:{name:"DiscardPadding",type:"Int"},14:{name:"Slices",type:"Container"},104:{name:"TimeSlice",type:"Container"},76:{name:"LaceNumber",type:"Uint"},77:{name:"FrameNumber",type:"Uint"},75:{name:"BlockAdditionID",type:"Uint"},78:{name:"Delay",type:"Uint"},79:{name:"SliceDuration",type:"Uint"},72:{name:"ReferenceFrame",type:"Container"},73:{name:"ReferenceOffset",type:"Uint"},74:{name:"ReferenceTimeCode",type:"Uint"},47:{name:"EncryptedBlock",type:"Binary"},106212971:{name:"Tracks",type:"Container"},46:{name:"TrackEntry",type:"Container"},87:{name:"TrackNumber",type:"Uint"},13253:{name:"TrackUID",type:"Uint"},3:{name:"TrackType",type:"Uint"},57:{name:"FlagEnabled",type:"Uint"},8:{name:"FlagDefault",type:"Uint"},5546:{name:"FlagForced",type:"Uint"},28:{name:"FlagLacing",type:"Uint"},11751:{name:"MinCache",type:"Uint"},11768:{name:"MaxCache",type:"Uint"},254851:{name:"DefaultDuration",type:"Uint"},216698:{name:"DefaultDecodedFieldDuration",type:"Uint"},209231:{name:"TrackTimecodeScale",type:"Float"},4991:{name:"TrackOffset",type:"Int"},5614:{name:"MaxBlockAdditionID",type:"Uint"},4974:{name:"Name",type:"String"},177564:{name:"Language",type:"String"},6:{name:"CodecID",type:"String"},9122:{name:"CodecPrivate",type:"Binary"},362120:{name:"CodecName",type:"String"},13382:{name:"AttachmentLink",type:"Uint"},1742487:{name:"CodecSettings",type:"String"},1785920:{name:"CodecInfoURL",type:"String"},438848:{name:"CodecDownloadURL",type:"String"},42:{name:"CodecDecodeAll",type:"Uint"},12203:{name:"TrackOverlay",type:"Uint"},5802:{name:"CodecDelay",type:"Uint"},5819:{name:"SeekPreRoll",type:"Uint"},9764:{name:"TrackTranslate",type:"Container"},9980:{name:"TrackTranslateEditionUID",type:"Uint"},9919:{name:"TrackTranslateCodec",type:"Uint"},9893:{name:"TrackTranslateTrackID",type:"Binary"},96:{name:"Video",type:"Container"},26:{name:"FlagInterlaced",type:"Uint"},5048:{name:"StereoMode",type:"Uint"},5056:{name:"AlphaMode",type:"Uint"},5049:{name:"OldStereoMode",type:"Uint"},48:{name:"PixelWidth",type:"Uint"},58:{name:"PixelHeight",type:"Uint"},5290:{name:"PixelCropBottom",type:"Uint"},5307:{name:"PixelCropTop",type:"Uint"},5324:{name:"PixelCropLeft",type:"Uint"},5341:{name:"PixelCropRight",type:"Uint"},5296:{name:"DisplayWidth",type:"Uint"},5306:{name:"DisplayHeight",type:"Uint"},5298:{name:"DisplayUnit",type:"Uint"},5299:{name:"AspectRatioType",type:"Uint"},963876:{name:"ColourSpace",type:"Binary"},1029411:{name:"GammaValue",type:"Float"},230371:{name:"FrameRate",type:"Float"},97:{name:"Audio",type:"Container"},53:{name:"SamplingFrequency",type:"Float"},14517:{name:"OutputSamplingFrequency",type:"Float"},31:{name:"Channels",type:"Uint"},15739:{name:"ChannelPositions",type:"Binary"},8804:{name:"BitDepth",type:"Uint"},98:{name:"TrackOperation",type:"Container"},99:{name:"TrackCombinePlanes",type:"Container"},100:{name:"TrackPlane",type:"Container"},101:{name:"TrackPlaneUID",type:"Uint"},102:{name:"TrackPlaneType",type:"Uint"},105:{name:"TrackJoinBlocks",type:"Container"},109:{name:"TrackJoinUID",type:"Uint"},64:{name:"TrickTrackUID",type:"Uint"},65:{name:"TrickTrackSegmentUID",type:"Binary"},70:{name:"TrickTrackFlag",type:"Uint"},71:{name:"TrickMasterTrackUID",type:"Uint"},68:{name:"TrickMasterTrackSegmentUID",type:"Binary"},11648:{name:"ContentEncodings",type:"Container"},8768:{name:"ContentEncoding",type:"Container"},4145:{name:"ContentEncodingOrder",type:"Uint"},4146:{name:"ContentEncodingScope",type:"Uint"},4147:{name:"ContentEncodingType",type:"Uint"},4148:{name:"ContentCompression",type:"Container"},596:{name:"ContentCompAlgo",type:"Uint"},597:{name:"ContentCompSettings",type:"Binary"},4149:{name:"ContentEncryption",type:"Container"},2017:{name:"ContentEncAlgo",type:"Uint"},2018:{name:"ContentEncKeyID",type:"Binary"},2019:{name:"ContentSignature",type:"Binary"},2020:{name:"ContentSigKeyID",type:"Binary"},2021:{name:"ContentSigAlgo",type:"Uint"},2022:{name:"ContentSigHashAlgo",type:"Uint"},206814059:{name:"Cues",type:"Container"},59:{name:"CuePoint",type:"Container"},51:{name:"CueTime",type:"Uint"},55:{name:"CueTrackPositions",type:"Container"},119:{name:"CueTrack",type:"Uint"},113:{name:"CueClusterPosition",type:"Uint"},112:{name:"CueRelativePosition",type:"Uint"},50:{name:"CueDuration",type:"Uint"},4984:{name:"CueBlockNumber",type:"Uint"},106:{name:"CueCodecState",type:"Uint"},91:{name:"CueReference",type:"Container"},22:{name:"CueRefTime",type:"Uint"},23:{name:"CueRefCluster",type:"Uint"},4959:{name:"CueRefNumber",type:"Uint"},107:{name:"CueRefCodecState",type:"Uint"},155296873:{name:"Attachments",type:"Container"},8615:{name:"AttachedFile",type:"Container"},1662:{name:"FileDescription",type:"String"},1646:{name:"FileName",type:"String"},1632:{name:"FileMimeType",type:"String"},1628:{name:"FileData",type:"Binary"},1710:{name:"FileUID",type:"Uint"},1653:{name:"FileReferral",type:"Binary"},1633:{name:"FileUsedStartTime",type:"Uint"},1634:{name:"FileUsedEndTime",type:"Uint"},4433776:{name:"Chapters",type:"Container"},1465:{name:"EditionEntry",type:"Container"},1468:{name:"EditionUID",type:"Uint"},1469:{name:"EditionFlagHidden",type:"Uint"},1499:{name:"EditionFlagDefault",type:"Uint"},1501:{name:"EditionFlagOrdered",type:"Uint"},54:{name:"ChapterAtom",type:"Container"},13252:{name:"ChapterUID",type:"Uint"},5716:{name:"ChapterStringUID",type:"String"},17:{name:"ChapterTimeStart",type:"Uint"},18:{name:"ChapterTimeEnd",type:"Uint"},24:{name:"ChapterFlagHidden",type:"Uint"},1432:{name:"ChapterFlagEnabled",type:"Uint"},11879:{name:"ChapterSegmentUID",type:"Binary"},11964:{name:"ChapterSegmentEditionUID",type:"Uint"},9155:{name:"ChapterPhysicalEquiv",type:"Uint"},15:{name:"ChapterTrack",type:"Container"},9:{name:"ChapterTrackNumber",type:"Uint"},0:{name:"ChapterDisplay",type:"Container"},5:{name:"ChapString",type:"String"},892:{name:"ChapLanguage",type:"String"},894:{name:"ChapCountry",type:"String"},10564:{name:"ChapProcess",type:"Container"},10581:{name:"ChapProcessCodecID",type:"Uint"},1293:{name:"ChapProcessPrivate",type:"Binary"},10513:{name:"ChapProcessCommand",type:"Container"},10530:{name:"ChapProcessTime",type:"Uint"},10547:{name:"ChapProcessData",type:"Binary"},39109479:{name:"Tags",type:"Container"},13171:{name:"Tag",type:"Container"},9152:{name:"Targets",type:"Container"},10442:{name:"TargetTypeValue",type:"Uint"},9162:{name:"TargetType",type:"String"},9157:{name:"TagTrackUID",type:"Uint"},9161:{name:"TagEditionUID",type:"Uint"},9156:{name:"TagChapterUID",type:"Uint"},9158:{name:"TagAttachmentUID",type:"Uint"},10184:{name:"SimpleTag",type:"Container"},1443:{name:"TagName",type:"String"},1146:{name:"TagLanguage",type:"String"},1156:{name:"TagDefault",type:"Uint"},1159:{name:"TagString",type:"String"},1157:{name:"TagBinary",type:"Binary"}};function e(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e}function u(e,t){this.name=e||"Unknown";this.type=t||"Unknown"}u.prototype.updateBySource=function(){};u.prototype.setSource=function(e){this.source=e;this.updateBySource()};u.prototype.updateByData=function(){};u.prototype.setData=function(e){this.data=e;this.updateByData()};function l(e,t){u.call(this,e,t||"Uint")}e(l,u);function n(e){return e.length%2===1?"0"+e:e}l.prototype.updateBySource=function(){this.data="";for(var e=0;e<this.source.length;e++){var t=this.source[e].toString(16);this.data+=n(t)}};l.prototype.updateByData=function(){var e=this.data.length/2;this.source=new Uint8Array(e);for(var t=0;t<e;t++){var n=this.data.substr(t*2,2);this.source[t]=parseInt(n,16)}};l.prototype.getValue=function(){return parseInt(this.data,16)};l.prototype.setValue=function(e){this.setData(n(e.toString(16)))};function f(e,t){u.call(this,e,t||"Float")}e(f,u);f.prototype.getFloatArrayType=function(){return this.source&&this.source.length===4?Float32Array:Float64Array};f.prototype.updateBySource=function(){var e=this.source.reverse();var t=this.getFloatArrayType();var n=new t(e.buffer);this.data=n[0]};f.prototype.updateByData=function(){var e=this.getFloatArrayType();var t=new e([this.data]);var n=new Uint8Array(t.buffer);this.source=n.reverse()};f.prototype.getValue=function(){return this.data};f.prototype.setValue=function(e){this.setData(e)};function c(e,t){u.call(this,e,t||"Container")}e(c,u);c.prototype.readByte=function(){return this.source[this.offset++]};c.prototype.readUint=function(){var e=this.readByte();var t=8-e.toString(2).length;var n=e-(1<<7-t);for(var r=0;r<t;r++){n*=256;n+=this.readByte()}return n};c.prototype.updateBySource=function(){this.data=[];for(this.offset=0;this.offset<this.source.length;this.offset=n){var e=this.readUint();var t=this.readUint();var n=Math.min(this.offset+t,this.source.length);var r=this.source.slice(this.offset,n);var i=s[e]||{name:"Unknown",type:"Unknown"};var a=u;switch(i.type){case"Container":a=c;break;case"Uint":a=l;break;case"Float":a=f;break}var o=new a(i.name,i.type);o.setSource(r);this.data.push({id:e,idHex:e.toString(16),data:o})}};c.prototype.writeUint=function(e,t){for(var n=1,r=128;e>=r&&n<8;n++,r*=128){}if(!t){var i=r+e;for(var a=n-1;a>=0;a--){var o=i%256;this.source[this.offset+a]=o;i=(i-o)/256}}this.offset+=n};c.prototype.writeSections=function(e){this.offset=0;for(var t=0;t<this.data.length;t++){var n=this.data[t],r=n.data.source,i=r.length;this.writeUint(n.id,e);this.writeUint(i,e);if(!e){this.source.set(r,this.offset)}this.offset+=i}return this.offset};c.prototype.updateByData=function(){var e=this.writeSections("draft");this.source=new Uint8Array(e);this.writeSections()};c.prototype.getSectionById=function(e){for(var t=0;t<this.data.length;t++){var n=this.data[t];if(n.id===e){return n.data}}return null};function a(e){c.call(this,"File","File");this.setSource(e)}e(a,c);a.prototype.fixDuration=function(e){var t=this.getSectionById(139690087);if(!t){console.log("[fix-webm-duration] Segment section is missing");return false}var n=t.getSectionById(88713574);if(!n){console.log("[fix-webm-duration] Info section is missing");return false}var r=n.getSectionById(710577);if(!r){console.log("[fix-webm-duration] TimecodeScale section is missing");return false}var i=n.getSectionById(1161);if(i){if(i.getValue()<=0){console.log("[fix-webm-duration] Duration section is present, but the value is empty");i.setValue(e)}else{console.log("[fix-webm-duration] Duration section is present");return false}}else{console.log("[fix-webm-duration] Duration section is missing");i=new f("Duration","Float");i.setValue(e);n.data.push({id:1161,data:i})}r.setValue(1e6);n.updateByData();t.updateByData();this.updateByData();return true};a.prototype.toBlob=function(){return new Blob([this.source.buffer],{type:"video/webm"})};return function(t,n,r){try{var i=new FileReader;i.onloadend=function(){try{var e=new a(new Uint8Array(i.result));if(e.fixDuration(n)){t=e.toBlob()}}catch(e){}r(t)};i.readAsArrayBuffer(t)}catch(e){r(t)}}})},{}],4:[function(e,t,n){"use strict";function r(e){"@babel/helpers - typeof";return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var o=a(e("../events"));var i=a(e("../event-handler"));function a(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function l(e,t,n){if(t)u(e.prototype,t);if(n)u(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}function f(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)c(e,t)}function c(e,t){c=Object.setPrototypeOf||function e(t,n){t.__proto__=n;return t};return c(e,t)}function d(i){var a=y();return function e(){var t=m(i),n;if(a){var r=m(this).constructor;n=Reflect.construct(t,arguments,r)}else{n=t.apply(this,arguments)}return p(this,n)}}function p(e,t){if(t&&(r(t)==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return h(e)}function h(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function y(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function m(e){m=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return m(e)}var v=function(e){f(r,e);var n=d(r);function r(e){var t;s(this,r);t=n.call(this,e,o.default.MEDIA_ATTACHED,o.default.BUFFER_CREATED,o.default.FILE_PARSING_DATA,o.default.FILE_HEAD_LOADED,o.default.FILE_DATA_LOADED,o.default.WEBSOCKET_ATTACHED,o.default.FRAG_PARSING_DATA,o.default.FRAG_PARSING_INIT_SEGMENT);t.fileStart=0;t.fileEnd=0;t.pendingAppending=0;t.mediaType=undefined;e:t.channelName;return t}l(r,[{key:"destroy",value:function e(){i.default.prototype.destroy.call(this)}},{key:"onMediaAttached",value:function e(t){console.log("media attached");if(t.websocketName!=undefined){var n="ws://"+window.location.host+"/"+t.websocketName;var r="binary";var i=new WebSocket(n,r);this.wfs.attachWebsocket(i,t.websocketName,t.channelName)}else{console.log("websocketName ERROE!!!")}}},{key:"onBufferCreated",value:function e(t){this.mediaType=t.mediaType}},{key:"onFileHeadLoaded",value:function e(t){}},{key:"onFileDataLoaded",value:function e(t){}},{key:"onFileParsingData",value:function e(t){}},{key:"onWebsocketAttached",value:function e(t){this.wfs.trigger(o.default.BUFFER_APPENDING,{type:"video",data:t.payload,parent:"main"})}},{key:"onFragParsingInitSegment",value:function e(t){var n=t.tracks,r,i;i=n.video;if(i){i.id=t.id}for(r in n){i=n[r];var a=i.initSegment;if(a){this.pendingAppending++;this.wfs.trigger(o.default.BUFFER_APPENDING,{type:r,data:a,parent:"main"})}}}},{key:"onFragParsingData",value:function e(t){var n=this;if(t.type==="video"){}[t.data1,t.data2].forEach(function(e){if(e){n.pendingAppending++;n.wfs.trigger(o.default.BUFFER_APPENDING,{type:t.type,data:e,parent:"main"})}})}}]);return r}(i.default);var g=v;n.default=g},{"../event-handler":8,"../events":9}],5:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var i=e("../utils/logger");function r(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function o(e,t,n){if(t)a(e.prototype,t);if(n)a(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}var s=function(){function t(e){r(this,t);this.data=e;this.bytesAvailable=this.data.byteLength;this.word=0;this.bitsAvailable=0}o(t,[{key:"loadWord",value:function e(){var t=this.data.byteLength-this.bytesAvailable,n=new Uint8Array(4),r=Math.min(4,this.bytesAvailable);if(r===0){throw new Error("no bytes available")}n.set(this.data.subarray(t,t+r));this.word=new DataView(n.buffer).getUint32(0);this.bitsAvailable=r*8;this.bytesAvailable-=r}},{key:"skipBits",value:function e(t){var n;if(this.bitsAvailable>t){this.word<<=t;this.bitsAvailable-=t}else{t-=this.bitsAvailable;n=t>>3;t-=n>>3;this.bytesAvailable-=n;this.loadWord();this.word<<=t;this.bitsAvailable-=t}}},{key:"readBits",value:function e(t){var n=Math.min(this.bitsAvailable,t),r=this.word>>>32-n;if(t>32){i.logger.error("Cannot read more than 32 bits at a time")}this.bitsAvailable-=n;if(this.bitsAvailable>0){this.word<<=n}else if(this.bytesAvailable>0){this.loadWord()}n=t-n;if(n>0){return r<<n|this.readBits(n)}else{return r}}},{key:"skipLZ",value:function e(){var t;for(t=0;t<this.bitsAvailable;++t){if(0!==(this.word&2147483648>>>t)){this.word<<=t;this.bitsAvailable-=t;return t}}this.loadWord();return t+this.skipLZ()}},{key:"skipUEG",value:function e(){this.skipBits(1+this.skipLZ())}},{key:"skipEG",value:function e(){this.skipBits(1+this.skipLZ())}},{key:"readUEG",value:function e(){var t=this.skipLZ();return this.readBits(t+1)-1}},{key:"readEG",value:function e(){var t=this.readUEG();if(1&t){return 1+t>>>1}else{return-1*(t>>>1)}}},{key:"readBoolean",value:function e(){return 1===this.readBits(1)}},{key:"readUByte",value:function e(){return this.readBits(8)}},{key:"readUShort",value:function e(){return this.readBits(16)}},{key:"readUInt",value:function e(){return this.readBits(32)}},{key:"skipScalingList",value:function e(t){var n=8,r=8,i,a;for(i=0;i<t;i++){if(r!==0){a=this.readEG();r=(n+a+256)%256}n=r===0?n:r}}},{key:"readSPS",value:function e(){var t=0,n=0,r=0,i=0,a=1,o,s,u,l,f,c,d,p,h;this.readUByte();o=this.readUByte();s=this.readBits(5);this.skipBits(3);u=this.readUByte();this.skipUEG();if(o===100||o===110||o===122||o===244||o===44||o===83||o===86||o===118||o===128){var y=this.readUEG();if(y===3){this.skipBits(1)}this.skipUEG();this.skipUEG();this.skipBits(1);if(this.readBoolean()){p=y!==3?8:12;for(h=0;h<p;h++){if(this.readBoolean()){if(h<6){this.skipScalingList(16)}else{this.skipScalingList(64)}}}}}this.skipUEG();var m=this.readUEG();if(m===0){this.readUEG()}else if(m===1){this.skipBits(1);this.skipEG();this.skipEG();l=this.readUEG();for(h=0;h<l;h++){this.skipEG()}}this.skipUEG();this.skipBits(1);f=this.readUEG();c=this.readUEG();d=this.readBits(1);if(d===0){this.skipBits(1)}this.skipBits(1);if(this.readBoolean()){t=this.readUEG();n=this.readUEG();r=this.readUEG();i=this.readUEG()}if(this.readBoolean()){if(this.readBoolean()){var v;var g=this.readUByte();switch(g){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:{v=[this.readUByte()<<8|this.readUByte(),this.readUByte()<<8|this.readUByte()];break}}if(v){a=v[0]/v[1]}}}return{width:Math.ceil(((f+1)*16-t*2-n*2)*a),height:(2-d)*(c+1)*16-(d?2:4)*(r+i)}}},{key:"readSliceType",value:function e(){this.readUByte();this.readUEG();return this.readUEG()}}]);return t}();var u=s;n.default=u},{"../utils/logger":16}],6:[function(e,t,n){"use strict";function r(e){"@babel/helpers - typeof";return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var i=e("../errors");var m=a(e("../events"));var v=a(e("./exp-golomb"));var o=a(e("../event-handler"));var s=a(e("../remux/mp4-remuxer"));function a(e){return e&&e.__esModule?e:{default:e}}function u(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function l(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function f(e,t,n){if(t)l(e.prototype,t);if(n)l(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}function c(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)d(e,t)}function d(e,t){d=Object.setPrototypeOf||function e(t,n){t.__proto__=n;return t};return d(e,t)}function p(i){var a=g();return function e(){var t=b(i),n;if(a){var r=b(this).constructor;n=Reflect.construct(t,arguments,r)}else{n=t.apply(this,arguments)}return h(this,n)}}function h(e,t){if(t&&(r(t)==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return y(e)}function y(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function g(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function b(e){b=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return b(e)}var E=function(e){c(a,e);var i=p(a);function a(e){var t;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;u(this,a);t=i.call(this,e,m.default.H264_DATA_PARSING);t.config=t.wfs.config||n;t.wfs=e;t.id="main";var r={mp4:MediaSource.isTypeSupported("video/mp4")};t.remuxer=new s.default(t.wfs,t.id,t.config);t.contiguous=true;t.timeOffset=1;t.sn=0;t.TIMESCALE=9e4;t.timestamp=0;t.scaleFactor=t.TIMESCALE/1e3;t.H264_TIMEBASE=t.config.mp4Duration;t._avcTrack={container:"video/mp4",type:"video",id:1,sequenceNumber:0,samples:[],len:0,nbNalu:0,dropped:0,count:0};t.browserType=0;if(navigator.userAgent.toLowerCase().indexOf("firefox")!==-1){t.browserType=1}return t}f(a,[{key:"destroy",value:function e(){o.default.prototype.destroy.call(this)}},{key:"getTimestampM",value:function e(){this.timestamp+=this.H264_TIMEBASE;return this.timestamp}},{key:"onH264DataParsing",value:function e(t){this._parseAVCTrack(t.data);if(this.browserType===1){this.remuxer.pushVideo(0,this.sn,this._avcTrack,this.timeOffset,this.contiguous);this.sn+=1}else{this.remuxer.pushVideo(0,this.sn,this._avcTrack,this.timeOffset,this.contiguous);this.sn+=1}}},{key:"_parseAVCTrack",value:function e(t){var a=this;var o=this._avcTrack,n=o.samples,r=this._parseAVCNALu(t),s=[],u=false,l=false,f=0,c,i,d,p;var h="";var y=function(){if(s.length){if(!this.config.forceKeyFrameOnDiscontinuity||l===true||o.sps&&(n.length||this.contiguous)){var e=this.getTimestampM();i={units:{units:s,length:f},pts:e,dts:e,key:l};n.push(i);o.len+=f;o.nbNalu+=s.length}else{o.dropped++}s=[];f=0}}.bind(this);r.forEach(function(e){switch(e.type){case 1:d=true;if(u){h+="NDR "}break;case 5:d=true;if(u){h+="IDR "}l=true;break;case 6:e.data=a.discardEPB(e.data);c=new v.default(e.data);c.readUByte();break;case 7:d=false;if(u){h+="SPS "}if(!o.sps){c=new v.default(e.data);var t=c.readSPS();o.width=t.width;o.height=t.height;o.sps=[e.data];o.duration=0;var n=e.data.subarray(1,4);var r="avc1.";for(p=0;p<3;p++){var i=n[p].toString(16);if(i.length<2){i="0"+i}r+=i}o.codec=r;a.wfs.trigger(m.default.BUFFER_RESET,{mimeType:o.codec});d=true}break;case 8:d=false;if(u){h+="PPS "}if(!o.pps){o.pps=[e.data];d=true}break;case 9:d=false;if(u){h+="AUD "}y();break;default:d=false;h+="unknown NAL "+e.type+" ";break}if(d){s.push(e);f+=e.data.byteLength}});if(u||h.length){logger.log(h)}y()}},{key:"_parseAVCNALu",value:function e(t){var n=0,r=t.byteLength,i,a,o=0;var s=[],u,l,f,c;while(n<r){i=t[n++];switch(o){case 0:if(i===0){o=1}break;case 1:if(i===0){o=2}else{o=0}break;case 2:case 3:if(i===0){o=3}else if(i===1&&n<r){l=t[n]&31;if(f){u={data:t.subarray(f,n-o-1),type:c};s.push(u)}else{}f=n;c=l;o=0}else{o=0}break;default:break}}if(f){u={data:t.subarray(f,r),type:c,state:o};s.push(u)}return s}},{key:"discardEPB",value:function e(t){var n=t.byteLength,r=[],i=1,a,o;while(i<n-2){if(t[i]===0&&t[i+1]===0&&t[i+2]===3){r.push(i+2);i+=2}else{i++}}if(r.length===0){return t}a=n-r.length;o=new Uint8Array(a);var s=0;for(i=0;i<a;s++,i++){if(s===r[0]){s++;r.shift()}o[i]=t[s]}return o}}]);return a}(o.default);var _=E;n.default=_},{"../errors":7,"../event-handler":8,"../events":9,"../remux/mp4-remuxer":15,"./exp-golomb":5}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.ErrorTypes=n.ErrorDetails=void 0;var r={NETWORK_ERROR:"networkError",MEDIA_ERROR:"mediaError",OTHER_ERROR:"otherError"};n.ErrorTypes=r;var i={MANIFEST_LOAD_ERROR:"manifestLoadError",MANIFEST_LOAD_TIMEOUT:"manifestLoadTimeOut",MANIFEST_PARSING_ERROR:"manifestParsingError",MANIFEST_INCOMPATIBLE_CODECS_ERROR:"manifestIncompatibleCodecsError",LEVEL_LOAD_ERROR:"levelLoadError",LEVEL_LOAD_TIMEOUT:"levelLoadTimeOut",LEVEL_SWITCH_ERROR:"levelSwitchError",AUDIO_TRACK_LOAD_ERROR:"audioTrackLoadError",AUDIO_TRACK_LOAD_TIMEOUT:"audioTrackLoadTimeOut",FRAG_LOAD_ERROR:"fragLoadError",FRAG_LOOP_LOADING_ERROR:"fragLoopLoadingError",FRAG_LOAD_TIMEOUT:"fragLoadTimeOut",FRAG_DECRYPT_ERROR:"fragDecryptError",FRAG_PARSING_ERROR:"fragParsingError",KEY_LOAD_ERROR:"keyLoadError",KEY_LOAD_TIMEOUT:"keyLoadTimeOut",BUFFER_ADD_CODEC_ERROR:"bufferAddCodecError",BUFFER_APPEND_ERROR:"bufferAppendError",BUFFER_APPENDING_ERROR:"bufferAppendingError",BUFFER_STALLED_ERROR:"bufferStalledError",BUFFER_FULL_ERROR:"bufferFullError",BUFFER_SEEK_OVER_HOLE:"bufferSeekOverHole",INTERNAL_EXCEPTION:"internalException",NETWORK_RECV_DATA_TIMEOUT:"networkRecvDataTimeout"};n.ErrorDetails=i},{}],8:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var r=i(e("./events"));function i(e){return e&&e.__esModule?e:{default:e}}function a(e){"@babel/helpers - typeof";return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function o(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function u(e,t,n){if(t)s(e.prototype,t);if(n)s(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}var l=function(){function i(e){o(this,i);this.wfs=e;this.onEvent=this.onEvent.bind(this);for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++){n[r-1]=arguments[r]}this.handledEvents=n;this.useGenericHandler=true;this.registerListeners()}u(i,[{key:"destroy",value:function e(){this.unregisterListeners()}},{key:"isEventHandler",value:function e(){return a(this.handledEvents)==="object"&&this.handledEvents.length&&typeof this.onEvent==="function"}},{key:"registerListeners",value:function e(){if(this.isEventHandler()){this.handledEvents.forEach(function(e){if(e==="wfsEventGeneric"){}this.wfs.on(e,this.onEvent)}.bind(this))}}},{key:"unregisterListeners",value:function e(){if(this.isEventHandler()){this.handledEvents.forEach(function(e){this.wfs.off(e,this.onEvent)}.bind(this))}}},{key:"onEvent",value:function e(t,n){this.onEventGeneric(t,n)}},{key:"onEventGeneric",value:function e(t,n){var r=function e(t,n){var r="on"+t.replace("wfs","");if(typeof this[r]!=="function"){}return this[r].bind(this,n)};try{r.call(this,t,n).call()}catch(e){console.log("internal error happened while processing ".concat(t,":").concat(e.message))}}}]);return i}();var f=l;n.default=f},{"./events":9}],9:[function(e,t,n){"use strict";t.exports={MEDIA_ATTACHING:"wfsMediaAttaching",MEDIA_ATTACHED:"wfsMediaAttached",FRAG_LOADING:"wfsFragLoading",BUFFER_CREATED:"wfsBufferCreated",BUFFER_APPENDING:"wfsBufferAppending",BUFFER_RESET:"wfsBufferReset",FRAG_PARSING_DATA:"wfsFragParsingData",FRAG_PARSING_INIT_SEGMENT:"wfsFragParsingInitSegment",H264_DATA_PARSING:"wfsH264DataParsing",WEBSOCKET_ATTACHED:"wfsWebsocketAttached",WEBSOCKET_ATTACHING:"wfsWebsocketAttaching",WEBSOCKET_DATA_UPLOADING:"wfsWebsocketDataUploading",WEBSOCKET_MESSAGE_SENDING:"wfsWebsocketMessageSending",FILE_HEAD_LOADING:"wfsFileHeadLoading",FILE_HEAD_LOADED:"wfsFileHeadLoaded",FILE_DATA_LOADING:"wfsFileDataLoading",FILE_DATA_LOADED:"wfsFileDataLoaded",FILE_PARSING_DATA:"wfsFileParsingData",RECORDING_START:"wfsRecordingStart",RECORDING_STOP:"wfsRecordingStop",ERROR:"wfsError"}},{}],10:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;function r(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function a(e,t,n){if(t)i(e.prototype,t);if(n)i(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}var o=function(){function e(){r(this,e)}a(e,null,[{key:"getSilentFrame",value:function e(t){if(t===1){return new Uint8Array([0,200,0,128,35,128])}else if(t===2){return new Uint8Array([33,0,73,144,2,25,0,35,128])}else if(t===3){return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142])}else if(t===4){return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56])}else if(t===5){return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56])}else if(t===6){return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}return null}}]);return e}();var s=o;n.default=s},{}],11:[function(e,t,n){"use strict";t.exports=e("./wfs.js").default},{"./wfs.js":19}],12:[function(e,t,n){"use strict";function r(e){"@babel/helpers - typeof";return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var i=o(e("../events"));var a=o(e("../event-handler"));function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function l(e,t,n){if(t)u(e.prototype,t);if(n)u(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}function f(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)c(e,t)}function c(e,t){c=Object.setPrototypeOf||function e(t,n){t.__proto__=n;return t};return c(e,t)}function d(i){var a=y();return function e(){var t=m(i),n;if(a){var r=m(this).constructor;n=Reflect.construct(t,arguments,r)}else{n=t.apply(this,arguments)}return p(this,n)}}function p(e,t){if(t&&(r(t)==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return h(e)}function h(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function y(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function m(e){m=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return m(e)}var v=function(e){f(r,e);var n=d(r);function r(e){var t;s(this,r);t=n.call(this,e,i.default.FRAG_LOADING,i.default.FILE_HEAD_LOADING,i.default.FILE_DATA_LOADING);t.loaders={};return t}l(r,[{key:"destroy",value:function e(){for(var t in this.loaders){var n=this.loaders[t];if(n){n.destroy()}}this.loaders={};a.default.prototype.destroy.call(this)}},{key:"onFileHeadLoading",value:function e(t){var n=this.wfs.config;var r=new n.loader(n);var i,a,o;i={url:n.fmp4FileUrl};a={maxRetry:0,retryDelay:0};o={onSuccess:this.fileloadheadsuccess.bind(this)};r.loadHead(i,a,o)}},{key:"fileloadheadsuccess",value:function e(t){this.wfs.trigger(i.default.FILE_HEAD_LOADED,{size:t})}},{key:"onFileDataLoading",value:function e(t){var n=this.wfs.config;var r=new n.loader(n);var i,a,o;i={url:n.fmp4FileUrl,responseType:"arraybuffer",progressData:false};var s=t.fileStart,u=t.fileEnd;if(!isNaN(s)&&!isNaN(u)){i.rangeStart=s;i.rangeEnd=u}a={timeout:n.fragLoadingTimeOut,maxRetry:0,retryDelay:0,maxRetryDelay:n.fragLoadingMaxRetryTimeout};o={onSuccess:this.fileloaddatasuccess.bind(this)};r.load(i,a,o)}},{key:"fileloaddatasuccess",value:function e(t,n,r){this.wfs.trigger(i.default.FILE_DATA_LOADED,{payload:t.data,stats:n})}},{key:"loaderror",value:function e(t,n){var r=n.loader;if(r){r.abort()}this.loaders[n.type]=undefined}},{key:"loadtimeout",value:function e(t,n){var r=n.loader;if(r){r.abort()}this.loaders[n.type]=undefined}},{key:"loadprogress",value:function e(t,n,r){var i=n.frag;i.loaded=t.loaded}}]);return r}(a.default);var g=v;n.default=g},{"../event-handler":8,"../events":9}],13:[function(e,t,n){"use strict";function r(e){"@babel/helpers - typeof";return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var i=e("../errors");var a=u(e("../events"));var o=u(e("../event-handler"));var s=u(e("../demux/h264-demuxer"));function u(e){return e&&e.__esModule?e:{default:e}}function l(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function f(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function c(e,t,n){if(t)f(e.prototype,t);if(n)f(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}function d(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)p(e,t)}function p(e,t){p=Object.setPrototypeOf||function e(t,n){t.__proto__=n;return t};return p(e,t)}function h(i){var a=v();return function e(){var t=g(i),n;if(a){var r=g(this).constructor;n=Reflect.construct(t,arguments,r)}else{n=t.apply(this,arguments)}return y(this,n)}}function y(e,t){if(t&&(r(t)==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return m(e)}function m(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function v(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function g(e){g=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return g(e)}var b=function(e){d(r,e);var n=h(r);function r(e){var t;l(this,r);t=n.call(this,e,a.default.WEBSOCKET_ATTACHING,a.default.WEBSOCKET_DATA_UPLOADING,a.default.WEBSOCKET_MESSAGE_SENDING);t.buf=null;t.ctx=null;t.h264Demuxer=new s.default(e);t.websocketName=undefined;t.media=undefined;t.mediaType=undefined;t.mediaCode=0;t.channelName=undefined;t.isForceClosed=false;t.timer=undefined;t.lastRecvDataTime=0;t.extraData=undefined;t.isLoaded=false;return t}c(r,[{key:"create_timer",value:function e(){var r=this;this.lastRecvDataTime=performance.now();console.log("Websocket: create_timer");this.timer=setInterval(function(){if(r.lastRecvDataTime>0){var e=performance.now();var t=e-r.lastRecvDataTime;if(t>r.wfs.config.wsMinPacketInterval){console.log("Websocket: did not recv data over "+t+" ms")}if(t>r.wfs.config.wsMaxPacketInterval&&!r.isForceClosed){r.unload();console.log("Websocket data not received in "+r.wfs.config.wsMaxPacketInterval/1e3+"s, open again...");var n={type:i.ErrorTypes.NETWORK_ERROR};n.details=i.ErrorDetails.NETWORK_RECV_DATA_TIMEOUT;n.fatal=true;r.wfs.trigger(a.default.ERROR,n)}}else{r.lastRecvDataTime=performance.now()}},this.wfs.config.wsMinPacketInterval)}},{key:"kill_timer",value:function e(){if(this.timer){console.log("Websocket close: clear timer");clearInterval(this.timer);this.timer=undefined}}},{key:"destroy",value:function e(){this.kill_timer();this.isForceClosed=true;!!this.client&&this.client.close();o.default.prototype.destroy.call(this)}},{key:"onWebsocketAttaching",value:function e(t){this.kill_timer();this.create_timer();switch(t.mediaType){case"MJPEG":this.mediaCode=1;this.ctx=t.media.getContext("2d");break;case"H264Raw":default:this.mediaCode=0;break}this.websocketName=t.websocketName;this.media=t.media;this.mediaType=t.mediaType;this.channelName=t.channelName;this.extraData=t.extraData;if(t.websocket instanceof WebSocket){this.client=t.websocket;this.client.onopen=this.initSocketClient.bind(this);this.client.onclose=this.closeSocketClient.bind(this);this.client.onerror=this.errorSocketClient.bind(this)}}},{key:"errorSocketClient",value:function e(t){this.unload();console.log("WebSocket error: ",t)}},{key:"closeSocketClient",value:function e(t){this.unload();console.log("Websocket closed: ",t)}},{key:"initSocketClient",value:function e(t){this.load();console.log("Websocket Open!")}},{key:"receiveSocketMessage",value:function e(t){var n=this;if(document["hidden"]){console.log("wfs websocket: document.hidden return!");if(this.isLoaded){this.lastRecvDataTime=performance.now()}return}if(!this.isLoaded){return}this.lastRecvDataTime=performance.now();if(this.mediaCode===0){this.buf=new Uint8Array(t.data);var r=new Uint8Array(this.buf);this.wfs.trigger(a.default.H264_DATA_PARSING,{data:r})}else if(this.mediaCode===1){if(this.extraData){if(!this.extraData.isDrawImg)return;if(this.media==undefined||!this.media)return;var i=new FileReader;i.onload=function(e){if(e.target.readyState===FileReader.DONE){var l=n.ctx;var f=new Image;var c=n.extraData.mjpeg_w;var d=n.extraData.mjpeg_h;var p=n.extraData.sizeOptionInd;var h=n.extraData.getObjectFitSize;f.onload=function(){l.clearRect(0,0,c,d);if(p===1){var e=h(p,c,d,this.width,this.height),t=e.sx,n=e.sy,r=e.swidth,i=e.sheight,a=e.x,o=e.y,s=e.width,u=e.height;l.drawImage(f,t,n,r,i,a,o,s,u)}else{l.drawImage(f,0,0,c,d)}};f.src=e.target.result}};i.readAsDataURL(t.data)}else{console.log("extraData is undefined");this.extraData=this.wfs.extraData}}}},{key:"onWebsocketDataUploading",value:function e(t){this.client.send(t.data)}},{key:"onWebsocketMessageSending",value:function e(t){this.client.send(JSON.stringify({t:t.commandType,c:t.channelName,v:t.commandValue}))}},{key:"load",value:function e(){if(this.mediaCode===0){this.client.binaryType="arraybuffer"}this.client.onmessage=this.receiveSocketMessage.bind(this);this.wfs.trigger(a.default.WEBSOCKET_MESSAGE_SENDING,{commandType:"open",channelName:this.channelName,commandValue:"NA"});this.isLoaded=true}},{key:"unload",value:function e(){this.isLoaded=false;if(this.mediaCode===1){this.ctx.clearRect(0,0,this.extraData.mjpeg_w,this.extraData.mjpeg_h)}}}]);return r}(o.default);var E=b;n.default=E},{"../demux/h264-demuxer":6,"../errors":7,"../event-handler":8,"../events":9}],14:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;function r(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function a(e,t,n){if(t)i(e.prototype,t);if(n)i(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}var o=function(){function p(){r(this,p)}a(p,null,[{key:"init",value:function e(){p.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var t;for(t in p.types){if(p.types.hasOwnProperty(t)){p.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]}}var n=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]);var r=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);p.HDLR_TYPES={video:n,audio:r};var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]);var a=new Uint8Array([0,0,0,0,0,0,0,0]);p.STTS=p.STSC=p.STCO=a;p.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);p.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]);p.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]);p.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var o=new Uint8Array([105,115,111,109]);var s=new Uint8Array([97,118,99,49]);var u=new Uint8Array([0,0,0,1]);p.FTYP=p.box(p.types.ftyp,o,u,o,s);p.DINF=p.box(p.types.dinf,p.box(p.types.dref,i))}},{key:"box",value:function e(t){var n=Array.prototype.slice.call(arguments,1),r=8,i=n.length,a=i,o;while(i--){r+=n[i].byteLength}o=new Uint8Array(r);o[0]=r>>24&255;o[1]=r>>16&255;o[2]=r>>8&255;o[3]=r&255;o.set(t,4);for(i=0,r=8;i<a;i++){o.set(n[i],r);r+=n[i].byteLength}return o}},{key:"hdlr",value:function e(t){return p.box(p.types.hdlr,p.HDLR_TYPES[t])}},{key:"mdat",value:function e(t){return p.box(p.types.mdat,t)}},{key:"mdhd",value:function e(t,n){n*=t;return p.box(p.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24,n>>16&255,n>>8&255,n&255,85,196,0,0]))}},{key:"mdia",value:function e(t){return p.box(p.types.mdia,p.mdhd(t.timescale,t.duration),p.hdlr(t.type),p.minf(t))}},{key:"mfhd",value:function e(t){return p.box(p.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255]))}},{key:"minf",value:function e(t){if(t.type==="audio"){return p.box(p.types.minf,p.box(p.types.smhd,p.SMHD),p.DINF,p.stbl(t))}else{return p.box(p.types.minf,p.box(p.types.vmhd,p.VMHD),p.DINF,p.stbl(t))}}},{key:"moof",value:function e(t,n,r){return p.box(p.types.moof,p.mfhd(t),p.traf(r,n))}},{key:"moov",value:function e(t){var n=t.length,r=[];while(n--){r[n]=p.trak(t[n])}return p.box.apply(null,[p.types.moov,p.mvhd(t[0].timescale,t[0].duration)].concat(r).concat(p.mvex(t)))}},{key:"mvex",value:function e(t){var n=t.length,r=[];while(n--){r[n]=p.trex(t[n])}return p.box.apply(null,[p.types.mvex].concat(r))}},{key:"mvhd",value:function e(t,n){n=0;var r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,t>>24&255,t>>16&255,t>>8&255,t&255,n>>24&255,n>>16&255,n>>8&255,n&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return p.box(p.types.mvhd,r)}},{key:"sdtp",value:function e(t){var n=t.samples||[],r=new Uint8Array(4+n.length),i,a;for(a=0;a<n.length;a++){i=n[a].flags;r[a+4]=i.dependsOn<<4|i.isDependedOn<<2|i.hasRedundancy}return p.box(p.types.sdtp,r)}},{key:"stbl",value:function e(t){return p.box(p.types.stbl,p.stsd(t),p.box(p.types.stts,p.STTS),p.box(p.types.stsc,p.STSC),p.box(p.types.stsz,p.STSZ),p.box(p.types.stco,p.STCO))}},{key:"avc1",value:function e(t){var n=[],r=[],i,a,o;for(i=0;i<t.sps.length;i++){a=t.sps[i];o=a.byteLength;n.push(o>>>8&255);n.push(o&255);n=n.concat(Array.prototype.slice.call(a))}for(i=0;i<t.pps.length;i++){a=t.pps[i];o=a.byteLength;r.push(o>>>8&255);r.push(o&255);r=r.concat(Array.prototype.slice.call(a))}var s=p.box(p.types.avcC,new Uint8Array([1,n[3],n[4],n[5],252|3,224|t.sps.length].concat(n).concat([t.pps.length]).concat(r))),u=t.width,l=t.height;return p.box(p.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,u>>8&255,u&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,106,101,102,102,45,121,97,110,47,47,47,103,119,102,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),s,p.box(p.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}},{key:"esds",value:function e(t){var n=t.config.length;return new Uint8Array([0,0,0,0,3,23+n,0,1,0,4,15+n,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([n]).concat(t.config).concat([6,1,2]))}},{key:"mp4a",value:function e(t){var n=t.audiosamplerate;return p.box(p.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,n>>8&255,n&255,0,0]),p.box(p.types.esds,p.esds(t)))}},{key:"stsd",value:function e(t){if(t.type==="audio"){return p.box(p.types.stsd,p.STSD,p.mp4a(t))}else{return p.box(p.types.stsd,p.STSD,p.avc1(t))}}},{key:"tkhd",value:function e(t){var n=t.id,r=t.duration*t.timescale,i=t.width,a=t.height;return p.box(p.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,n>>24&255,n>>16&255,n>>8&255,n&255,0,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,i&255,0,0,a>>8&255,a&255,0,0]))}},{key:"traf",value:function e(t,n){var r=p.sdtp(t),i=t.id;return p.box(p.types.traf,p.box(p.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,i&255])),p.box(p.types.tfdt,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255])),p.trun(t,r.length+16+16+8+16+8+8),r)}},{key:"trak",value:function e(t){t.duration=t.duration||4294967295;return p.box(p.types.trak,p.tkhd(t),p.mdia(t))}},{key:"trex",value:function e(t){var n=t.id;return p.box(p.types.trex,new Uint8Array([0,0,0,0,n>>24,n>>16&255,n>>8&255,n&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}},{key:"trun",value:function e(t,n){var r=t.samples||[],i=r.length,a=12+16*i,o=new Uint8Array(a),s,u,l,f,c,d;n+=8+a;o.set([0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,i&255,n>>>24&255,n>>>16&255,n>>>8&255,n&255],0);for(s=0;s<i;s++){u=r[s];l=u.duration;f=u.size;c=u.flags;d=u.cts;o.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,f>>>24&255,f>>>16&255,f>>>8&255,f&255,c.isLeading<<2|c.dependsOn,c.isDependedOn<<6|c.hasRedundancy<<4|c.paddingValue<<1|c.isNonSync,c.degradPrio&240<<8,c.degradPrio&15,d>>>24&255,d>>>16&255,d>>>8&255,d&255],12+16*s)}return p.box(p.types.trun,o)}},{key:"initSegment",value:function e(t){if(!p.types){p.init()}var n=p.moov(t),r;r=new Uint8Array(p.FTYP.byteLength+n.byteLength);r.set(p.FTYP);r.set(n,p.FTYP.byteLength);return r}}]);return p}();var s=o;n.default=s},{}],15:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var G=r(e("../helper/aac"));var j=r(e("../events"));var H=e("../utils/logger");var V=r(e("../remux/mp4-generator"));var h=e("../errors");e("../utils/polyfill");function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function a(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function o(e,t,n){if(t)a(e.prototype,t);if(n)a(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}var s=function(){function r(e,t,n){i(this,r);this.observer=e;this.id=t;this.config=n;this.ISGenerated=false;this.PES2MP4SCALEFACTOR=4;this.PES_TIMESCALE=9e4;this.MP4_TIMESCALE=this.PES_TIMESCALE/this.PES2MP4SCALEFACTOR;this.nextAvcDts=90300;this.H264_TIMEBASE=this.config.mp4Duration;this.genISFailCount=0}o(r,[{key:"passthrough",get:function e(){return false}},{key:"destroy",value:function e(){}},{key:"insertDiscontinuity",value:function e(){this._initPTS=this._initDTS=undefined}},{key:"switchLevel",value:function e(){this.ISGenerated=false;this.genISFailCount=0}},{key:"pushVideo",value:function e(t,n,r,i,a){this.level=t;this.sn=n;var o;if(!this.ISGenerated){this.generateVideoIS(r,i)}if(this.ISGenerated){this.remuxVideo_2(r,i,a)}}},{key:"remuxVideo_2",value:function e(t,n,r,i){var a=8,o,s,u=t.samples,l=[];o=new Uint8Array(t.len+4*t.nbNalu+8);var f=new DataView(o.buffer);f.setUint32(0,o.byteLength);o.set(V.default.types.mdat,4);var c=0;var d,p,h,y;for(var m=0;m<u.length;m++){var v=u[m],g=0;while(v.units.units.length){var b=v.units.units.shift();f.setUint32(a,b.data.byteLength);a+=4;o.set(b.data,a);a+=b.data.byteLength;g+=4+b.data.byteLength}var E=v.pts-this._initPTS;var _=v.dts-this._initDTS;_=Math.min(E,_);if(y!==undefined){d=this._PTSNormalize(E,y);p=this._PTSNormalize(_,y);c=p-y;if(c<=0){H.logger.log("invalid sample duration at PTS/DTS: ".concat(v.pts,"/").concat(v.dts,"|dts norm: ").concat(p,"|lastDTS: ").concat(y,":").concat(c));c=1}}else{var S=this.nextAvcDts,w;d=this._PTSNormalize(E,S);p=this._PTSNormalize(_,S);if(S){w=Math.round(p-S);if(Math.abs(w)<600){if(w){if(w>1){H.logger.log("AVC:".concat(w," ms hole between fragments detected,filling it"))}else if(w<-1){H.logger.log("AVC:".concat(-w," ms overlapping between fragments detected"))}p=S;d=Math.max(d-w,p);H.logger.log("Video/PTS/DTS adjusted: ".concat(d,"/").concat(p,",delta:").concat(w))}}}this.firstPTS=Math.max(0,d);this.firstDTS=Math.max(0,p);c=.03}l.push({size:g,duration:this.H264_TIMEBASE,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:v.key?2:1,isNonSync:v.key?0:1}});y=p}var T=0;if(l.length>=2){T=l[l.length-2].duration;l[0].duration=T}this.nextAvcDts=p+T;t.len=0;t.nbNalu=0;t.dropped=0;if(l.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var k=l[0].flags;k.dependsOn=2;k.isNonSync=0}t.samples=l;s=V.default.moof(t.sequenceNumber++,p,t);t.samples=[];var A={data1:s,data2:o,type:"video"};this.observer.trigger(j.default.FRAG_PARSING_DATA,A);return A}},{key:"generateVideoIS",value:function e(t,n){var r=this.observer,i=t.samples,a=this.PES_TIMESCALE,o={},s={id:this.id,level:this.level,sn:this.sn,tracks:o,unique:false},u=this._initPTS===undefined,l,f;if(u){l=f=Infinity}if(t.sps&&t.pps&&i.length){t.timescale=9e4;o.video={container:"video/mp4",codec:t.codec,initSegment:V.default.initSegment([t]),metadata:{width:t.width,height:t.height}};if(u){l=Math.min(l,i[0].pts-this.H264_TIMEBASE);f=Math.min(f,i[0].dts-this.H264_TIMEBASE)}}if(Object.keys(o).length){r.trigger(j.default.FRAG_PARSING_INIT_SEGMENT,s);this.ISGenerated=true;this.genISFailCount=0;if(u){this._initPTS=l;this._initDTS=f}}else{this.genISFailCount++;if(this.genISFailCount>60){console.log("generateVideoIS ERROR: ",h.ErrorTypes.MEDIA_ERROR)}}}},{key:"remux",value:function e(t,n,r,i,a,o,s,u){this.level=t;this.sn=n;if(!this.ISGenerated){this.generateIS(r,i,s)}if(this.ISGenerated){if(r.samples.length){var l=this.remuxAudio(r,s,u);if(i.samples.length){var f;if(l){f=l.endPTS-l.startPTS}this.remuxVideo(i,s,u,f)}}else{var c;if(i.samples.length){c=this.remuxVideo(i,s,u)}if(c&&r.codec){this.remuxEmptyAudio(r,s,u,c)}}}if(a.samples.length){this.remuxID3(a,s)}if(o.samples.length){this.remuxText(o,s)}this.observer.trigger(j.default.FRAG_PARSED,{id:this.id,level:this.level,sn:this.sn})}},{key:"generateIS",value:function e(t,n,r){var i=this.observer,a=t.samples,o=n.samples,s=this.PES_TIMESCALE,u={},l={id:this.id,level:this.level,sn:this.sn,tracks:u,unique:false},f=this._initPTS===undefined,c,d;if(f){c=d=Infinity}if(t.config&&a.length){t.timescale=t.audiosamplerate;if(t.timescale*t.duration>Math.pow(2,32)){var p=function e(t,n){if(!n){return t}return e(n,t%n)};t.timescale=t.audiosamplerate/p(t.audiosamplerate,1024)}H.logger.log("audio mp4 timescale :"+t.timescale);u.audio={container:"audio/mp4",codec:t.codec,initSegment:V.default.initSegment([t]),metadata:{channelCount:t.channelCount}};if(f){c=d=a[0].pts-s*r}}if(n.sps&&n.pps&&o.length){n.timescale=this.MP4_TIMESCALE;u.video={container:"video/mp4",codec:n.codec,initSegment:V.default.initSegment([n]),metadata:{width:n.width,height:n.height}};if(f){c=Math.min(c,o[0].pts-s*r);d=Math.min(d,o[0].dts-s*r)}}if(Object.keys(u).length){i.trigger(j.default.FRAG_PARSING_INIT_SEGMENT,l);this.ISGenerated=true;if(f){this._initPTS=c;this._initDTS=d}}else{i.trigger(j.default.ERROR,{type:h.ErrorTypes.MEDIA_ERROR,id:this.id,details:h.ErrorDetails.FRAG_PARSING_ERROR,fatal:false,reason:"no audio/video samples found"})}}},{key:"remuxVideo",value:function M(e,t,n,r){var i=8,a=this.PES_TIMESCALE,o=this.PES2MP4SCALEFACTOR,s,u,l,f,c,d,p,h,y=e.samples,m=[];var v;if(n){v=this.nextAvcDts}else{v=t*a}var g=y[0];c=Math.max(this._PTSNormalize(g.dts,v)-this._initDTS,0);f=Math.max(this._PTSNormalize(g.pts,v)-this._initDTS,0);var b=Math.round((c-v)/90);if(n){if(b){if(b>1){H.logger.log("AVC:".concat(b," ms hole between fragments detected,filling it"))}else if(b<-1){H.logger.log("AVC:".concat(-b," ms overlapping between fragments detected"))}c=v;y[0].dts=c+this._initDTS;f=Math.max(f-b,v);y[0].pts=f+this._initDTS;H.logger.log("Video/PTS/DTS adjusted: ".concat(f,"/").concat(c,",delta:").concat(b))}}d=c;g=y[y.length-1];h=Math.max(this._PTSNormalize(g.dts,v)-this._initDTS,0);p=Math.max(this._PTSNormalize(g.pts,v)-this._initDTS,0);p=Math.max(p,h);var E=navigator.vendor,_=navigator.userAgent,S=E&&E.indexOf("Apple")>-1&&_&&!_.match("CriOS");if(S){s=Math.round((h-c)/(o*(y.length-1)))}for(var w=0;w<y.length;w++){var T=y[w];if(S){T.dts=c+w*o*s}else{T.dts=Math.max(this._PTSNormalize(T.dts,v)-this._initDTS,c);T.dts=Math.round(T.dts/o)*o}T.pts=Math.max(this._PTSNormalize(T.pts,v)-this._initDTS,T.dts);T.pts=Math.round(T.pts/o)*o}u=new Uint8Array(e.len+4*e.nbNalu+8);var k=new DataView(u.buffer);k.setUint32(0,u.byteLength);u.set(V.default.types.mdat,4);for(var A=0;A<y.length;A++){var D=y[A],R=0,C=void 0;while(D.units.units.length){var U=D.units.units.shift();k.setUint32(i,U.data.byteLength);i+=4;u.set(U.data,i);i+=U.data.byteLength;R+=4+U.data.byteLength}if(!S){if(A<y.length-1){s=y[A+1].dts-D.dts}else{var O=this.config,P=D.dts-y[A>0?A-1:A].dts;if(O.stretchShortVideoTrack){var B=O.maxBufferHole,F=O.maxSeekHole,N=Math.floor(Math.min(B,F)*a),x=(r?f+r*a:this.nextAacPts)-D.pts;if(x>N){s=x-P;if(s<0){s=P}H.logger.log("It is approximately ".concat(x/90," ms to the next segment; using duration ").concat(s/90," ms for the last video frame."))}else{s=P}}else{s=P}}s/=o;C=Math.round((D.pts-D.dts)/o)}else{C=Math.max(0,s*Math.round((D.pts-D.dts)/(o*s)))}m.push({size:R,duration:s,cts:C,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:D.key?2:1,isNonSync:D.key?0:1}})}this.nextAvcDts=h+s*o;var G=e.dropped;e.len=0;e.nbNalu=0;e.dropped=0;if(m.length&&navigator.userAgent.toLowerCase().indexOf("chrome")>-1){var L=m[0].flags;L.dependsOn=2;L.isNonSync=0}e.samples=m;l=V.default.moof(e.sequenceNumber++,c/o,e);e.samples=[];var I={id:this.id,level:this.level,sn:this.sn,data1:l,data2:u,startPTS:f/a,endPTS:(p+o*s)/a,startDTS:f/a,endDTS:(p+o*s)/a,type:"video",nb:m.length,dropped:G};this.observer.trigger(j.default.FRAG_PARSING_DATA,I);return I}},{key:"remuxAudio",value:function M(e,t,n){var r=this.PES_TIMESCALE,B=e.timescale,i=r/B,F=e.timescale*1024/e.audiosamplerate;var a,o=8,s,u,l,f,c,d,p,h,y,m,v,g,b=[],E=[];e.samples.sort(function(e,t){return e.pts-t.pts});E=e.samples;var _=n?this.nextAacPts:t*r;var N=this._PTSNormalize(E[0].pts-this._initPTS,_),S=F*i;var w=N+S;for(var T=1;T<E.length;){var k=E[T],A=this._PTSNormalize(k.pts-this._initPTS,_),D=A-w;if(D<-.5*S){H.logger.log("Dropping frame due to ".concat(Math.abs(D/90)," ms overlap."));E.splice(T,1);e.len-=k.unit.length}else if(D>.5*S){var R=Math.round(D/S);H.logger.log("Injecting ".concat(R," frame").concat(R>1?"s":""," of missing audio due to ").concat(Math.round(D/90)," ms gap."));for(var C=0;C<R;C++){var U=E[T-1].pts+S,O=G.default.getSilentFrame(e.channelCount);if(!O){H.logger.log("Unable to get silent frame for given audio codec; duplicating last frame instead.");O=k.unit.slice(0)}E.splice(T,0,{unit:O,pts:U,dts:U});e.len+=O.length;T+=1}w+=(R+1)*S;k.pts=E[T-1].pts+S;T+=1}else{if(Math.abs(D)>.1*S){H.logger.log("Invalid frame delta ".concat(A-w+S," at PTS ").concat(Math.round(A/90)," (should be ").concat(S,")."))}w+=S;k.pts=E[T-1].pts+S;T+=1}}while(E.length){s=E.shift();l=s.unit;y=s.pts-this._initDTS;m=s.dts-this._initDTS;if(h!==undefined){v=this._PTSNormalize(y,h);g=this._PTSNormalize(m,h);u.duration=(g-h)/i}else{v=this._PTSNormalize(y,_);g=this._PTSNormalize(m,_);var P=Math.round(1e3*(v-_)/r);if(n){if(P){if(P>0){H.logger.log("".concat(P," ms hole between AAC samples detected,filling it"))}else if(P<-12){H.logger.log("".concat(-P," ms overlapping between AAC samples detected, drop frame"));e.len-=l.byteLength;continue}v=g=_}}d=Math.max(0,v);p=Math.max(0,g);if(e.len>0){f=new Uint8Array(e.len+8);a=new DataView(f.buffer);a.setUint32(0,f.byteLength);f.set(V.default.types.mdat,4)}else{return}}f.set(l,o);o+=l.byteLength;u={size:l.byteLength,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}};b.push(u);h=g}var x=0;var L=b.length;if(L>=2){x=b[L-2].duration;u.duration=x}if(L){this.nextAacPts=v+i*x;e.len=0;e.samples=b;c=V.default.moof(e.sequenceNumber++,p/i,e);e.samples=[];var I={id:this.id,level:this.level,sn:this.sn,data1:c,data2:f,startPTS:d/r,endPTS:this.nextAacPts/r,startDTS:p/r,endDTS:(g+i*x)/r,type:"audio",nb:L};this.observer.trigger(j.default.FRAG_PARSING_DATA,I);return I}return null}},{key:"remuxEmptyAudio",value:function e(t,n,r,i){var a=this.PES_TIMESCALE,o=t.timescale?t.timescale:t.audiosamplerate,s=a/o,u=i.startDTS*a+this._initDTS,l=i.endDTS*a+this._initDTS,f=1024,c=s*f,d=Math.ceil((l-u)/c),p=G.default.getSilentFrame(t.channelCount);if(!p){H.logger.trace("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!");return}var h=[];for(var y=0;y<d;y++){var m=u+y*c;h.push({unit:p.slice(0),pts:m,dts:m});t.len+=p.length}t.samples=h;this.remuxAudio(t,n,r)}},{key:"remuxID3",value:function e(t,n){var r=t.samples.length,i;if(r){for(var a=0;a<r;a++){i=t.samples[a];i.pts=(i.pts-this._initPTS)/this.PES_TIMESCALE;i.dts=(i.dts-this._initDTS)/this.PES_TIMESCALE}this.observer.trigger(j.default.FRAG_PARSING_METADATA,{id:this.id,level:this.level,sn:this.sn,samples:t.samples})}t.samples=[];n=n}},{key:"remuxText",value:function e(t,n){t.samples.sort(function(e,t){return e.pts-t.pts});var r=t.samples.length,i;if(r){for(var a=0;a<r;a++){i=t.samples[a];i.pts=(i.pts-this._initPTS)/this.PES_TIMESCALE}this.observer.trigger(j.default.FRAG_PARSING_USERDATA,{id:this.id,level:this.level,sn:this.sn,samples:t.samples})}t.samples=[];n=n}},{key:"_PTSNormalize",value:function e(t,n){var r;if(n===undefined){return t}if(n<t){r=-8589934592}else{r=8589934592}while(Math.abs(t-n)>4294967296){t+=r}return t}}]);return r}();var u=s;n.default=u},{"../errors":7,"../events":9,"../helper/aac":10,"../remux/mp4-generator":14,"../utils/logger":16,"../utils/polyfill":17}],16:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.logger=n.enableLogs=void 0;function r(e){"@babel/helpers - typeof";return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function a(){}var i={trace:a,debug:a,log:a,warn:a,info:a,error:a};var o=i;function s(e,t){t="["+e+"] > "+t;return t}function u(r){var i=window.console[r];if(i){return function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++){t[n]=arguments[n]}if(t[0]){t[0]=s(r,t[0])}i.apply(window.console,t)}}return a}function l(t){for(var e=arguments.length,n=new Array(e>1?e-1:0),r=1;r<e;r++){n[r-1]=arguments[r]}n.forEach(function(e){o[e]=t[e]?t[e].bind(t):u(e)})}var f=function e(t){if(t===true||r(t)==="object"){l(t,"debug","log","info","warn","error");try{o.log()}catch(e){o=i}}else{o=i}};n.enableLogs=f;var c=o;n.logger=c},{}],17:[function(e,t,n){"use strict";if(typeof ArrayBuffer!=="undefined"&&!ArrayBuffer.prototype.slice){ArrayBuffer.prototype.slice=function(e,t){var n=new Uint8Array(this);if(t===undefined){t=n.length}var r=new ArrayBuffer(t-e);var i=new Uint8Array(r);for(var a=0;a<i.length;a++){i[a]=n[a+e]}return r}}},{}],18:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;function r(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function i(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function a(e,t,n){if(t)i(e.prototype,t);if(n)i(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}var o=function(){function t(e){r(this,t);if(e&&e.xhrSetup){this.xhrSetup=e.xhrSetup}}a(t,[{key:"destroy",value:function e(){this.abort();this.loader=null}},{key:"abort",value:function e(){var t=this.loader;if(t&&t.readyState!==4){this.stats.aborted=true;t.abort()}window.clearTimeout(this.requestTimeout);this.requestTimeout=null;window.clearTimeout(this.retryTimeout);this.retryTimeout=null}},{key:"loadHead",value:function e(t,n,r){this.context=t;this.config=n;this.callbacks=r;this.stats={trequest:performance.now(),retry:0};this.retryDelay=n.retryDelay;var i=new XMLHttpRequest;i.open("head",t.url);i.onload=function(){r.onSuccess(i.getResponseHeader("content-length"))};i.send()}},{key:"load",value:function e(t,n,r){this.context=t;this.config=n;this.callbacks=r;this.stats={trequest:performance.now(),retry:0};this.retryDelay=n.retryDelay;this.loadInternal()}},{key:"loadInternal",value:function e(){var t,n=this.context;if(typeof XDomainRequest!=="undefined"){t=this.loader=new XDomainRequest}else{t=this.loader=new XMLHttpRequest}t.onloadend=this.loadend.bind(this);t.onprogress=this.loadprogress.bind(this);t.open("GET",n.url,true);if(n.rangeEnd){t.setRequestHeader("Range","bytes="+n.rangeStart+"-"+(n.rangeEnd-1))}t.responseType=n.responseType;var r=this.stats;r.tfirst=0;r.loaded=0;if(this.xhrSetup){this.xhrSetup(t,n.url)}this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),this.config.timeout);t.send()}},{key:"loadend",value:function e(t){var n=t.currentTarget,r=n.status,i=this.stats,a=this.context,o=this.config;if(i.aborted){return}window.clearTimeout(this.requestTimeout);if(r>=200&&r<300){i.tload=Math.max(i.tfirst,performance.now());var s,u;if(a.responseType==="arraybuffer"){s=n.response;u=s.byteLength}else{s=n.responseText;u=s.length}i.loaded=i.total=u;var l={url:n.responseURL,data:s};this.callbacks.onSuccess(l,i,a)}else{if(i.retry>=o.maxRetry||r>=400&&r<499){this.callbacks.onError({code:r,text:n.statusText},a)}else{this.destroy();this.retryTimeout=window.setTimeout(this.loadInternal.bind(this),this.retryDelay);this.retryDelay=Math.min(2*this.retryDelay,o.maxRetryDelay);i.retry++}}}},{key:"loadtimeout",value:function e(){this.callbacks.onTimeout(this.stats,this.context)}},{key:"loadprogress",value:function e(t){var n=this.stats;if(n.tfirst===0){n.tfirst=Math.max(performance.now(),n.trequest)}n.loaded=t.loaded;if(t.lengthComputable){n.total=t.total}var r=this.callbacks.onProgress;if(r){r(n,this.context,null)}}}]);return t}();var s=o;n.default=s},{}],19:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:true});n.default=void 0;var i=e("./errors");var s=c(e("./events"));var o=c(e("./controller/flow-controller"));var u=c(e("./controller/buffer-controller"));var l=c(e("events"));var a=c(e("./utils/xhr-loader"));var r=c(e("./loader/file-loader"));var f=c(e("./loader/websocket-loader"));function c(e){return e&&e.__esModule?e:{default:e}}function d(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function p(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||false;r.configurable=true;if("value"in r)r.writable=true;Object.defineProperty(e,r.key,r)}}function h(e,t,n){if(t)p(e.prototype,t);if(n)p(e,n);Object.defineProperty(e,"prototype",{writable:false});return e}var y=function(){function r(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};d(this,r);var t=r.DefaultConfig;for(var n in t){if(n in e){continue}e[n]=t[n]}this.config=e;var a=this.observer=new l.default;a.trigger=function e(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++){r[i-1]=arguments[i]}a.emit.apply(a,[t,t].concat(r))};a.off=function e(t){for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++){r[i-1]=arguments[i]}a.removeListener.apply(a,[t].concat(r))};this.on=a.on.bind(a);this.off=a.off.bind(a);this.trigger=a.trigger.bind(a);this.flowController=new o.default(this);this.bufferController=new u.default(this);this.websocketLoader=new f.default(this);this.mediaType=undefined;this.extraData=undefined}h(r,[{key:"destroy",value:function e(){console.log("wfs destroy +++");this.flowController.destroy();this.bufferController.destroy();this.websocketLoader.destroy();console.log("wfs destroy ---")}},{key:"attachMedia",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"chX";var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"H264Raw";var i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:"play2";var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:undefined;this.mediaType=r;this.media=t;this.extraData=a;var o=undefined;switch(r){case"MJPEG":o=s.default.MEDIA_ATTACHED;break;case"H264Raw":default:o=s.default.MEDIA_ATTACHING;break}this.trigger(o,{media:t,channelName:n,mediaType:r,websocketName:i,extraData:this.extraData})}},{key:"attachWebsocket",value:function e(t,n,r){this.trigger(s.default.WEBSOCKET_ATTACHING,{websocket:t,websocketName:n,media:this.media,mediaType:this.mediaType,channelName:r,extraData:this.extraData})}},{key:"start_recording",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1*(1024*1024*1024);var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:undefined;var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:undefined;this.trigger(s.default.RECORDING_START,{rec_file_threshold:t,result_cb:n,state_cb:r})}},{key:"stop_recording",value:function e(){this.trigger(s.default.RECORDING_STOP)}}],[{key:"version",get:function e(){return""+"v.0.0.0.1"}},{key:"isSupported",value:function e(){return window.MediaSource&&typeof window.MediaSource.isTypeSupported==="function"&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42c01f,mp4a.40.2"')}},{key:"Events",get:function e(){return s.default}},{key:"ErrorTypes",get:function e(){return i.ErrorTypes}},{key:"ErrorDetails",get:function e(){return i.ErrorDetails}},{key:"DefaultConfig",get:function e(){if(!r.defaultConfig){r.defaultConfig={autoStartLoad:true,startPosition:-1,debug:false,fLoader:undefined,loader:a.default,fmp4FileUrl:"xxxx.mp4",fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3,fragLoadingLoopThreshold:3,forceKeyFrameOnDiscontinuity:true,appendErrorMaxRetry:3,wsMinPacketInterval:3e3,wsMaxPacketInterval:3e4,mp4Duration:1e3}}return r.defaultConfig},set:function e(t){r.defaultConfig=t}}]);return r}();var m=y;n.default=m},{"./controller/buffer-controller":2,"./controller/flow-controller":4,"./errors":7,"./events":9,"./loader/file-loader":12,"./loader/websocket-loader":13,"./utils/xhr-loader":18,events:1}]},{},[11])(11)});